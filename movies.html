<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Movies</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <style>
        .movie-card {
            padding: 5px 5px;
            margin: 5px 5px;

            max-width: 300px;
            border: 1px solid black;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div id="my-movies" class="d-flex flex-wrap">

    </div>

    <hr>
    <h5 id="add-form-label">Add a movie</h5>
    <div id="add-movie-form">
        <div class="form-group">
            <label for="add-title">Title</label>
            <input id="add-title" value="" placeholder="Title">
        </div>
        <button type="button" id="add-btn" class="mt-2" data-id="0">Save movie</button>
        <button type="button" id="clear-add-btn" class="mt-2" data-id="0">Clear form</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.3.js" integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM=" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

<script>
  (function() {
      const BASE_URL = 'https://lush-screeching-dart.glitch.me/movies';

      let movies = undefined;

      function fetchMovies() {
          fetch(BASE_URL)
              .then(function (response) {
                  return response.json();
              }).then(function (data) {
                  movies = data;
                  // console.log(data)
                  // now that I have my movie data from glitch
                  // call a function that displays it in the dom
                  displayMovies();
          });
      }

      function displayMovies() {
          // won't be called until movies is loaded
          let html = "";
          for (let i = 0; i < movies.length; i++) {
              html += `
<div class="movie-card">
<p>${movies[i].id} : ${movies[i].name}</p>
<button type="button" data-id="${movies[i].id}" class="my-edit-btn">Edit</button>
<button type="button" data-id="${movies[i].id}" class="my-delete-btn">Delete</button>
</div>`;

          }
          $("#my-movies").html(html);

          // now that the delete buttons are in the DOM, add the click listeners for them
          $(".my-edit-btn").click(function(event) {
              const movieId = $(this).data("id");
              editMovie(movieId);
          });
          $(".my-delete-btn").click(function(event) {
              const movieId = $(this).data("id");
              deleteMovie(movieId);
          });
      }

      function editMovie(movieId) {
          for (let i = 0; i < movies.length; i++) {
              if(movies[i].id === movieId) {
                  // prepare the add movie form
                  $("#add-form-label").text("Edit a movie");
                  $("#add-title").val(movies[i].name);
                  $("#add-btn").data("id", movieId);
                  return;
              }
          }
          console.log("ERROR: could not find movie id " + movieId);
      }

      function deleteMovie(movieId) {
          const options = {
              method: 'DELETE',
              headers: {
                  'Content-Type': 'application/json',
              }
          };
          fetch(BASE_URL + "/" + movieId, options).then(function() {
                  fetchMovies();
              }).catch(/* handle errors */);
      }

      function saveMovie(movieId) {
          const movie = {
              name: $("#add-title").val()
          };
          let url = BASE_URL;
          const options = {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify(movie),
          };
          if(movieId > 0) {
              options.method = "PUT";
              url += "/" + movieId;
          }
          fetch(url, options)
              .then(function() {
                  fetchMovies();
                  // reset the add form
                  clearAddForm();
              }).catch(/* handle errors */);
      }

      function clearAddForm() {
          $("#add-title").val("");
          $("#add-form-label").text("Add a movie");
          $("#add-btn").data("id", 0);
      }

      // fetch the movies when the page loads
      $(document).ready(function() {
          fetchMovies();

          // add a handler for the add button
          $("#add-btn").click(function(event) {
              const movieId = $(this).data("id");
              saveMovie(movieId);
          });
          $("#clear-add-btn").click(function(event) {
              clearAddForm();
          });
      });


  })()

</script>
</body>
</html>